---
- name: karrot.world | setup
  hosts: all
  become: yes
  vars_files:
    - secrets.vars.yml
  vars:
    site: karrot-world
    server_name: karrot.world
    redirects:
      - alpha.foodsaving.world
      - app.foodsaving.world
      - www.karrot.world
      - fstool.yunity.org
  tasks:

    - name: check ansible version
      include_role:
        name: check-ansible-version

    - name: basic-site
      include_role:
        name: basic-site

    - name: karrot-backend
      include_role:
        name: karrot-backend
      vars:
        site_name: karrot.world
        static_root: /home/deploy/karrot-frontend/release
        from_email_address: karrot.world <noreply@karrot.world>
        redis_db: 2
        influxdb_database: fstool
        postgresql_database: fstool
        postgresql_user: fstool
        workers: 4

    - name: karrot-backups
      include_role:
        name: karrot-backups
      vars:
        postgresql_database: fstool
        gpg_id: B88A03E5
        offsite_server: tiltec@81.30.158.213:backup/
        gpg_secret_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          34613335663465623439613734633462656564656565343739303966643235366238616361613237
          3530616434323535616661666564636537643634636131350a306536383763306136396664313135
          39336161373530393561323838393436666532666361323935373534653137653739353330643964
          3531336464626332340a643033623966323539316465323338333630613262343566353331653232
          33393830636238363632353066643231393964656463373161366266623431343932313233303763
          62626134666533363361306231313437636136613231333462643230643030663631666535626165
          37633737613363663037386636366264393664326230373563383632376361376135353935663134
          32333631393762393237373465623133656434363365616131366161323335363338393739313338
          62366134396463636531633263306166666230393365303163653139323237656636613530613661
          30663462366230313236656436656639383232376636616164653430313463343538396333656335
          36353662663963373862393063643166656164633234613039343434393734653361353536663031
          62663434656161626462616462616332643266653062633336326238666562353537626264343836
          61336236353831643465663537636464646563616530336463313231343630366634616636383563
          61313634303938653630366135363335353865306438323431646666663163336364363334373632
          34323535663437323437306465323035343531373636363733656433363333393362383033363265
          62386362363131623564306633393630356663653339303637333037346239376566323330663133
          61663334343832646636323132646132316366616232633839656330386661663162383636323936
          38303039666437373131643763336536343564643734313635393763653530396439643664656464
          61666631646163643436303664333939383764646665386536363838616134653564643161386533
          63633064313139623963633163626433646366326534376166643562326663656436396634623338
          38333232323137356361663663626462356631653436333930663635356265333233393435313038
          32623033656631313532646665396265313934353637373236633830363836623136643532313830
          33316238313234383065383137663632393137373465633132336262656362616330643433323831
          32623432383439666332343762393237333465393266313435613037643336656461333439393566
          31393732633530326561393266653030643136613762353533663262623236353139363963613930
          33343837323266656530636336393366616561373734373962333962666465636134643236313265
          33363933343834343538343862363033656331653531653561616333643439306363633961303362
          31363638353663346339303730663364636462626233343930636533343435633737353564623561
          35316135623963656536326539366136306433336364383062393034663637613139303961363764
          36633036326332653739623463383734626666613335333237343631303837626630373234336665
          62623034643339316664663862353639353138303765323233373564613062613333633161383836
          32303335393235333235666639613938386663333534653338386266306135666433386465393737
          35363463336531613362663063663831326464616237643464303232356633356564366133333963
          63376536303861663930326633316536666162623436346436323633646662356530353534623539
          63383564333636643764313962373839383163316530613665626464316339623064636133363438
          63653630313934663633636331656638643732333934373836623935353736666561303031363531
          30646239353366333333333136373135653963653463363636383538396262396162653438383831
          34366366656566666336396563636331393166393563653235313731613435626161623266336362
          66353239616531353230346165616335336337636461366533666133653438376338306135383531
          66666432396636633635303836343637366637613964353461613565333533626162383761616132
          63306130373639323036373936653430396339376163323066336630633736633732363061336232
          65646464323431326531633165373664356362333931623339303132643661323239646662313635
          33373362643638326334313961643330313135313836366335653830336133393831363839353036
          36373566623235373264306336616465393138653861613861353637653765643238633634663132
          32663332643461623762656132653661396234336331306338663862393935333138303665663461
          63366531396565613934343738376566306339613064613264663431633965663765396633366465
          35353137313535356438613263326165613638336334343138383939386265636535616330373335
          30653535353636383632303332313261363431653639356562306231633331313336656563656433
          37303738613134336562306236356630373661306363376430303738363662343135366461383032
          63643061303366316339313834333463363838373733653935336434616238313031356636616437
          35333134396434666633633230363236376531623738643831313964393839353230303465623132
          63336537383466666632633037636138666462613565653232643663346630373532396364326538
          64333761613937306434316465653861383138653937356665613439376663616431323064353966
          30363339303466313634353432326137613035653766313731333339623231336234356662306138
          31313034393730346435303738663733646332336235323662336535343539316230336538643632
          33393363376134643233633336393939643965396361343864376637363033393230326263646637
          63653764376632313534353232633138643163636461653664333763343663303434636434663430
          64333838666438363361393866343430363264376334303233613232633938373933386535393139
          65306339303533393365626330373532323632643838623030306364643933353139636265306562
          63306635643332383337626636663230386338333533336132343930663336376161626636613338
          35666536313231353836666664626135346462326235346539393937633935303031333762656233
          62633463663131633664373563616436633736356235663739653337383064646262626132316234
          32393339663263323338653464313930616237653737346561386431613439326363633334353966
          37663234636432613965376131363330333438333438323139613632356535376432643830643764
          36636630353866663737393035653231646137303465643535613739666435623739383363313032
          62663233366134353963373133373764303733623764333366313834626264376663386537353861
          37313131656432393637323532666266306331643038383162313466316266623435326634306230
          36316137656437343232353262353736353335343434353261663836656162316362666366626361
          37643365313963313435646631386438346561373834653161613361393265303666393963376436
          38313266323265616663323032626136303764663936346364643038353063643932376562643565
          36626339643536386232616336383165313863313863383961306237306333656535623831383631
          33616161333137343733633339626237643165303564316536393366353233313862373038343033
          34333437326439356465306265396333373164613336393230623266303766336431316536636264
          33643466356533633362396537386536643964393931616335343033336639353231366439386630
          34336335353838373038633463393564353764646336336339663664343764346133666430653362
          63336464646630343939653361616663393565646164623635636363653130356236363035353232
          31323537383765653435653832663262646630646435336439653433363335326365386263623430
          37303661393739636635663735376631653461316431633536643237643037373764366634663861
          62393536363536663330383834386234396638326137356665643733316339326533643762326632
          36613830646264353739386134373735353066343836623661636261646330613631326130316563
          34306236383262333035626436646636373362373766633666623832633135326165313136346261
          33343363346231343333376561326632326239666561333734396339386331626235333138333866
          30643063303666336565336630336639303133663832656534313766336332326437353937646332
          63306566303932636534373666626638333139356337343764363633613336633436613861303734
          30393337376537666364636232633635353031343736616537653238666432393835326334626331
          31373962616466623439356165343938376661636339323232356366346531616230303266363737
          35353534303430363663316331636463666366333130303534343261653966613264633761316333
          63393536616138646263333864373764313636623939623139316332613538353664626661353537
          31313434393931653832303934326361386639383639343231346437356663353638653864623131
          33346265356233396337366439636233306134646132383166633638316630323030343664303336
          65613463383137666264353062643163613031666537386366316433346137646434393532343135
          63346562366238386465643831343661396135626561616362623533373463373636316135356464
          62313366306530636439366362326230306332623235623461623131373538616132353235373535
          64313431633436623264656466383237306163306235306561303537656264646335653461353262
          32313531663237376439666637396131323038636435366330366466343266313235353265373463
          31356338626365653432663532633139353230316230643864376638643964393632336233393162
          33333765363538333838303336303662363462656332346237313064363835623532363363663130
          38303730376533373861393137626330323165386664303132373365343463333461386334363061
          33333164633861356630313438333866356662376561313635316163363337393965396665333564
          64393334656261633138393463373432373832663763303935316236653238616466633065383431
          30666236323731323461663861663762313831623735646635636132316430313438373934356131
          37333436383962626363326666343036383162613161373336363239373665386461656638623135
          37393233373664323030636539373964613838353037653931613436663536393366316530343934
          34633639626236626361393066396134363132393830313361663633373730363966666437633561
          34646163303834346563326237656338313331616564326531646139353430396664366665323933
          65313062386462373062363238616136323462633063623831316563323165666664303562346165
          31643739323662633066316632656238366430333332623130663337383135626137396163313365
          39656337646232303538326130323234656439376565333737393835356136303132316436383266
          37393435373462333966623362396432396562633863633164313963623137323632663665303135
          63373037363566626539333864346234343865663438313233633930396366306236633561316636
          30333532326435613265306366633665663636326663313566643135386139396234363461303439
          62326531333032323134653436346133346630646534353265666665313931393533646563303730
          65313939363236393033366633623861363830386437313565356661666438363261653636636239
          64353363646534616461653865633564353365376437656362333561323132336633613030623339
          62393665656337333964373139393835373433663766626464396239373933663836373962663666
          38343435663566616662653530353839393535666633336661303733656562653439336462313635
          34343565376433373733326333386134663639323061626331653931383365343265626230393265
          32626235396537613331633063663932356439373465386661383336633234353034646131376532
          64303165653666383766663139393862393566353365386436373936653762663830646166313934
          62663165313664383762356366306566333931626139316437396430646333663561623239343534
          34343164363339353235643132356436633231333738656662373236646261656266343939316631
          32383561636536326131343566323963653230353639333336376232646366373635613639366161
          34366637393466303263363238623931636531306332326538616335623466363063616665306631
          64633634636363356462343237363962626132626330356236613936643832366161346439616437
          39343466303235663061613564353665326630396264633231636235306462313033613064366631
          37363566303736626432316161656661393132666564653865306237306164386334636438643231
          66643365376665613830303765366331636436376664626637653535643564333733656535633766
          61323738336431653838393536666438373965626533383538343031313661633764336238343139
          39336335633663656337613039623035626333353761653130613165303166336639383064396334
          38326462356361323666326130386265653732653332616565386234373831393666386439376261
          32383839313839613938626332623633613361316434303136643462363833306638336631356331
          39616237323431353834663032646662396630616633636263623062303733366164613062343036
          62316463373166653433626431636435393630353237336238636535363562613036396339613432
          64346462323163643366623765316135653739393031343531666639373834623035636364653661
          36613061643534666439323664316664343130653738333631663339373634386433393039363131
          36643034363936393038643433616630636635363065663332353362613935663262353161333536
          66346435613634333034653336646565303865346261366463663263313236636639393635356361
          64613039643135326530353465613134656537393139653439353463333664316638396163663464
          62353331666633643435333362343436306638616434356561666564356236323035613939643139
          34666431383231353761313934306666653834626466663734323861313531626531353134393630
          66303232316636653862663666303334333838663338646332396164303562363635393634646438
          32646230373330303664353066653230383266386439343264346564356336663033353133656234
          30646664633536333062383839306333343333333461386264656231646231363736666231306366
          63643262643363613730663064636262316136663435393433353363656437333637353536613966
          39353632326236343037646261323730633733396539623563643161613466343663666662346663
          30646262326533653539393664333639306134306532336230656661653336383431363366303235
          61613431643633613334383962643538386333343266623237613262646364643261663435623461
          61646266373662346566336663386132363464633336366538373637386439386663363630373862
          36623130663133343438656664323332616664373037653963626439613064623438336262313530
          63343236343437646337643364356365313764303264396135636536633136653633653137343539
          64373939363563643261363637666430373431663261346135393732633964376364393262623830
          37323537633430613735376237653136316664323135333463306461346632316233363061646638
          33643665626136386133663662336363303635643739366561653335396135366464613834376534
          39666363616332623436633936363566363764663765333534326664663361386634636530623765
          30353831346339336334643330656435333032393065393835666135656232313864303237333731
          35383439303565646634373938346235306336313033303839336333363739623561626637316562
          37323766383566306566353463363931636634653037613637646234653237363135323563343430
          33363234383732666635626232396434336137373839386665313031393337663337386638643836
          61366335353135613434646632306634306336316130316465616434386536373462666131376262
          66383861653761623861633062643264643866366266633265623338643862313030333161653261
          32346562613066306164373561333163336530636561623735326234363965636666616430333565
          32313565366531306533623565316465353334623863633734633631326539303539316566386432
          61306134306461623931383438626330396364303738353334316531313635336265353530633965
          31633630343363663432323761393539663635346562383032353630636230383464316231343036
          62616236613831643038633034393764386631633734303033366263666134643765646230666163
          37386461646430363638343931393831316233653730653930626665356162316637653337316433
          30333530363463353430323632343737386366376263353330623063306136636565323862323539
          37313335643864623139323337386332333564396264396234383238643664383165393736346464
          33363266316239353362346334396335366635343263633864636333343532386264626664303830
          31333231316533333164666635373933633062653033636231633638373835393332333234303730
          35396332636566643537333436616565306533323034366236666430623066396231646261666234
          38343361343632656132393237623835303537353334653932383031336235326462663138393433
          39373362353964626533313162323936323038343135303539343966303732306562643662373333
          38393234653264386362323536616463323666306436383639643831346532306430306661643533
          31666461373937626430663730643063343166393763326639616133313033663039383666616263
          63666563323534333434666663656636313965633237613266316661336230316436653430343233
          61326166643062383938353562316264663739333631613936336439363561353433363235346565
          35366161323762386364636262326537363336643532366233316265666233346336383537333736
          39366230643639333039376230393530323636643164316330373133393831326639393336386239
          61323636633036373938336536376236356262376262646331306664343261343263333835306433
          34396339616661373733643035353432303433373234656238653831653430373566633266303134
          33636231396263306633623634386264613661323238616562666334323061373833373731303239
          61666666663536363335313835376263653631363037303437633361613435373234326334346564
          61313439323664313838333466383761363032353439303635643636323739386638386533323737
          31386565373931316235386237613865383930346264653537643465393266616137666232356234
          30386439373239373564353361386236616237666662353763613437633964656362616135393231
          65383661643564663734646639313466366431373666633165303365393832336439656639303835
          32356562663833386336373532646238366139646132646335633836343139623938363461383466
          30373436663431333835313838613937363636353036623231316638396562643433663832366335
          30373034386538663564383435666264346334393365666535373836363636363063613630303064
          32343335303535396439626335383164333232316434663538323865633739396361333131313537
          31303762633733633032366564663037393334346565633534306466323665346562333032666633
          35313430643764396564633634343064323439323537313634353638353466613933333661633733
          61383137643239386163326463376461636330333536376432383039353430616132313730646565
          66343534353137613265316639356431653736633066616538383737396631333763396266633762
          38666563623339363234333865653032356635323166336564313965393037366565653537656431
          64636666393837646438316138616336316465316262386565626139363935333865383761313466
          61333530653430636539623162383364306631656663663963303731383537343137646330383031
          39383039306536383136373634306535623237396463386232326334353761383666393934366433
          34336665643530376637333931643233393061353066643666396261386631323738373136306635
          66313230643437333231373066316430396136346136616334396633386166616436346333323765
          32623064653163323564356364333661393161333535393137356332373231643061363930323432
          33306463376138666464393635613562623639613432316530396465393962636466373436373639
          31653631646230343665393764383236343536613262663634306435626136653135643065663963
          35363666303965336163383262363631306463353766393865323934396332316336363330326636
          65326431333038366136623265323334626461666139636638323066656134643238613335303266
          62353439613339306432336264333930646238393131363033366337393739393938333530373164
          36323062343965643065376234343164636665663831623039613539313130616337663065643163
          63393861396132633031356565613462326532663662366330303834613461383730313364373365
          63663832306365633432313731353561663239303930646537643933343662316538363265646663
          62636335646538306364653531316237623935656536386363623035626163346637653135303865
          31323037363636623565613733616338316565353766666662633362363830386461616465363639
          39336165653636376564636463356462383063656161363238623833383762363561666365396633
          62373837366134356365323763386134663461333138343437613838313261353439626637613062
          61356465303234366439656363386236336366306261646639323865333738303839313664616330
          65323065353932623161643934373565616138666338313431346538306534336633333166343636
          36653332613966353065343030393334303965313139643336643235613836343066386130313664
          34626664323539346332376663373762616166303035313066666362353364626538363264386366
          37323166383233353964323734636139366438633534326139616632303233363232393938323735
          31636536386463653239333430633931656535656334303734303662393166666263346332393562
          61656131363132643664353135663232333739653865616164386435396433386131313132363837
          37323964366261656536303235343161653562653138666566303339663839653263373461356333
          65633437313431653261336337386163666336666265333164623764366436356339343064336235
          37383764353730333937346137393366653635616530346233313330366664636466653231366563
          61343630343364666665303133643264383439323735366466646138656434343837306138323133
          33366434613134393232353439663164373836613265316530363938346639623830356662303235
          64383664653436636431336633313639366364303966323932353937343337623262363766363836
          65653337616464663132353665653963323738636362353231383634363739646138313034396261
          38336338636664386235336238613566666334393361333565383136393561373635373638393835
          34653538303961306639363666656137363138633933333431313465636362643731376539623732
          62643534343634303630663834373163393536643463343839343136366439653934396636333133
          63623430656339613432353536626566623739336665646339373463623661343539656434373535
          30313635383466636238343363633134326639363933636634366566623863353333376132383339
          62333537376431353739643863663862303931323666623130356431663064626432383363346133
          30623765393433626362306662656162303361393536643536623637326633623362383433653433
          38313736636230306633393233336566313937316538346635623931643964313163313662396131
          33383937303738353361636437376236643436316362643466393135326431363334613830333034
          31306233643262326238626661613466313637356139373031656361333830646261326331656433
          64326565623538633734653138323365363264643732626434353631356163646438623764633034
          35343665613431386363303666383733656633353964333839333235306637613338623566633162
          61616133623935386266353266633236616538613866666664653032623531656565343036343735
          35363030613866666434623938643735313938303434316635303937346437346364393137396130
          36623935656264376339613339643466633665633230383261333631343135616462326361633561
          33663465636533643561343338663239316265326263333837373063653765623335663961343433
          64353165663263333033666238323838333133336162326564353139626331316562383635363861
          6362316264376663333933373265383036626264393566393932

